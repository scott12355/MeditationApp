<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="MeditationApp.Controls.CalendarView"
             x:Name="CalendarViewRoot">

    <Frame BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray900}}"
           CornerRadius="15"
           Padding="0"
           HasShadow="True">
        <VerticalStackLayout Spacing="0">

            <!-- Calendar Header with Month/Year and Navigation -->
            <Grid BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                  ColumnDefinitions="Auto,*,Auto"
                  Padding="15,10"
                  HeightRequest="60">

                <Button Grid.Column="0"
                        Text="‹"
                        FontSize="18"
                        BackgroundColor="Transparent"
                        TextColor="White"
                        WidthRequest="40"
                        HeightRequest="40"
                        CornerRadius="20"
                        Command="{Binding PreviousMonthCommand}"/>

                <Label Grid.Column="1"
                       Text="{Binding CurrentMonthYear}"
                       FontSize="18"
                       FontAttributes="Bold"
                       TextColor="White"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"/>

                <Button Grid.Column="2"
                        Text="›"
                        FontSize="18"
                        BackgroundColor="Transparent"
                        TextColor="White"
                        WidthRequest="40"
                        HeightRequest="40"
                        CornerRadius="20"
                        Command="{Binding NextMonthCommand}"/>
            </Grid>

            <!-- Days of Week Header -->
            <Grid ColumnDefinitions="*,*,*,*,*,*,*"
                  BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray800}}"
                  HeightRequest="40">

                <Label Grid.Column="0"
                       Text="Sun"
                       FontSize="14"
                       FontAttributes="Bold"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"/>
                <Label Grid.Column="1"
                       Text="Mon"
                       FontSize="14"
                       FontAttributes="Bold"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"/>
                <Label Grid.Column="2"
                       Text="Tue"
                       FontSize="14"
                       FontAttributes="Bold"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"/>
                <Label Grid.Column="3"
                       Text="Wed"
                       FontSize="14"
                       FontAttributes="Bold"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"/>
                <Label Grid.Column="4"
                       Text="Thu"
                       FontSize="14"
                       FontAttributes="Bold"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"/>
                <Label Grid.Column="5"
                       Text="Fri"
                       FontSize="14"
                       FontAttributes="Bold"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"/>
                <Label Grid.Column="6"
                       Text="Sat"
                       FontSize="14"
                       FontAttributes="Bold"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"/>
            </Grid>

            <!-- Calendar Days Grid -->
            <CollectionView ItemsSource="{Binding CalendarDays}"
                            BackgroundColor="Transparent"
                            RemainingItemsThreshold="0"
                            SelectionMode="None">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Vertical"
                                     Span="7"
                                     VerticalItemSpacing="1"
                                     HorizontalItemSpacing="1"/>
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <!-- Simplified item template for better performance -->
                        <Grid BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray800}}"
                              HeightRequest="45"
                              WidthRequest="45">

                            <!-- Day button with minimal styling -->
                            <Button BackgroundColor="Transparent"
                                    Text="{Binding Day}"
                                    FontSize="14"
                                    TextColor="{Binding TextColor}"
                                    FontAttributes="{Binding FontWeight}"
                                    CornerRadius="0"
                                    BorderWidth="0"
                                    Command="{Binding Source={x:Reference Name=CalendarViewRoot}, Path=BindingContext.DayTappedCommand}"
                                    CommandParameter="{Binding}"
                                    IsEnabled="{Binding IsCurrentMonth}">

                                <!-- Simplified triggers for better performance -->
                                <Button.Triggers>
                                    <DataTrigger TargetType="Button"
                                                 Binding="{Binding IsSelected}"
                                                 Value="True">
                                        <!-- Remove BackgroundColor fill, only set TextColor -->
                                        <Setter Property="TextColor"
                                                Value="White"/>
                                    </DataTrigger>

                                    <DataTrigger TargetType="Button"
                                                 Binding="{Binding IsToday}"
                                                 Value="True">
                                        <Setter Property="BorderColor"
                                                Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"/>
                                        <Setter Property="BorderWidth"
                                                Value="2"/>
                                    </DataTrigger>
                                </Button.Triggers>
                            </Button>

                            <!-- Session indicator - optimized positioning -->
                            <Border IsVisible="{Binding HasSession}"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                    WidthRequest="6"
                                    HeightRequest="6"
                                    StrokeShape="RoundRectangle 3"
                                    HorizontalOptions="Center"
                                    VerticalOptions="End"
                                    Margin="0,0,0,8"
                                    InputTransparent="True"/>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

        </VerticalStackLayout>
    </Frame>
</ContentView>
